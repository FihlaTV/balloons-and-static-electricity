<!DOCTYPE HTML>
<!-- Copyright 2016, University of Colorado Boulder -->

<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="phet-sim-level" content="production">
  <title>&#8234;Balloons and Static Electricity&#8236; 1.2.0-reader.7 accessibility test</title>
</head>
<body bgcolor="#F0F8FF">
<style>
  body {
    font-family: Arial, Helvetica, sans-serif
  }
  div.simulation_frame {
    float: left;
    margin: 50px;
  }
  div.pdom_copy {
    float: left;
    margin-top: 50px;
  }
  div.pdom_copy_container {
    overflow: auto;
    width: 500px;
    height: 500px;
  }
  div.alert_copy_container {
    width: 500px;
    height: 250px;
    overflow: auto;
  }
  div.clearfix {
    clear: both;
  }
  p.alert {
    opacity: 0.6;
  }
</style>

<h1>Accessibility visualization for &#8234;Balloons and Static Electricity&#8236;</h1>

<div class="simulation_frame">
  <h2>Simulation embedded below</h2>
  <iframe id="iframe" width="600" height="400" allowfullscreen scrolling="no" style="float: left display: inline"></iframe>
</div>

<script type="application/javascript">

  // Grab all query parameters to pass to the simulation, and add additional ones for receiving messages.
  var simulationQueryString = window.location.search;
  if ( simulationQueryString.indexOf( '?' ) >= 0 ) {
    simulationQueryString += '&';
  }
  else {
    simulationQueryString += '?';
  }
  simulationQueryString += 'postMessageOnLoad&postMessageOnError';
  document.getElementById( 'iframe' ).setAttribute( 'src', 'balloons-and-static-electricity_en.html' + simulationQueryString );
</script>

<!--The PDOM copy will be placed in this container -->
<div class="pdom_copy">
  <h2>Parallel DOM is copied below</h2>
  <h3>Interaction alerts</h3>
  <div id=alert-copy-container class=alert_copy_container>
    <div id='assertive-element-container'>
      <p class='alert'>&#10092;assertive update&#10093;</p>
      <p id="assertive-element-copy"></p>
    </div>
    <div id='polite-element-container'>
      <p class='alert'>&#10092;polite update&#10093;</p>
      <p id="polite-element-copy"></p>
    </div>
    <div id='assertive-alert-element-container'>
      <p class='alert'>&#10092;assertive alert update&#10093;</p>
      <p id="assertive-alert-element-copy"></p>
    </div>
    <div id='polite-alert-element-container'>
      <p class='alert'>&#10092;polite status update&#10093;</p>
      <p id="polite-status-element-copy"></p>
    </div>
  </div>
  <div id=dom-copy-container class="pdom_copy_container"></div>
</div>

<!--clear the blocks after the float effect-->
<div class="clearfix"></div>

<script type="application/javascript">

  // handling messages from sims
  window.addEventListener( 'message', function( evt ) {
    var data = JSON.parse( evt.data );

    // if load is successful, create a visualization of the parallel DOM
    if ( data.type === 'load' ) {

      var iframe = document.getElementById( 'iframe' );
      var innerDoc = iframe.contentDocument || iframe.contentWindow.document;

      // copy of the parallel DOM
      var pDOM = innerDoc.getElementsByClassName( 'accessibility' )[ 0 ];
      var pDOMCopy = pDOM.cloneNode( true );

      // copy the alert content      
      var assertiveElement = innerDoc.getElementById( 'assertive' );
      var politeElement = innerDoc.getElementById( 'polite' );
      var assertiveAlertElement = innerDoc.getElementById( 'assertive-alert' );
      var politeStatusElement = innerDoc.getElementById( 'polite-status' );

      var assertiveElementCopy = document.getElementById( 'assertive-element-copy' );
      var politeElementCopy = document.getElementById( 'polite-element-copy');
      var assertiveAlertElementCopy = document.getElementById( 'assertive-alert-element-copy');
      var politeStatusElementCopy = document.getElementById( 'polite-status-element-copy');

      // strip the styling from the copied DOM elements
      pDOMCopy.style = '';
      assertiveElement.style = '';
      politeElement.style = '';
      assertiveAlertElement.style = '';
      politeStatusElement.style = '';

      // get the parent container for the parallel DOM copy and the alert content
      var copyContainer = document.getElementById( 'dom-copy-container' );
      var assertiveElementContainer = document.getElementById( 'assertive-element-container' );
      var politeElementContainer = document.getElementById( 'polite-element-container' );
      var assertiveAlertElementContainer = document.getElementById( 'assertive-alert-element-container' );
      var politeStatusElementContainer = document.getElementById( 'polite-status-element-container' );

      // add the copies to the outer document
      copyContainer.appendChild( pDOMCopy );

      // remove all elements in the PDOM copy from the navigation order
      var removeTabIndex = function() {
        var allElements = pDOMCopy.getElementsByTagName( "*" );
        for ( var i = 0; i < allElements.length; i++ ) {
          // Do something with the element here
          allElements[ i ].tabIndex = '-1';
        }
      };
      removeTabIndex();

      // whenever an element in the parallel DOM changes, we need to update its 
      // copied element as well
      var domObserver = new MutationObserver( function( mutations ) {
        mutations.forEach( function( mutation ) {

          // This is extremely ineficient - every time the document changes, make a new copy, remove
          // the visual dom, and add a new one
          // TODO: Work on refining this, and only modifying the elements that change in the PDOM.
          copyContainer.removeChild( pDOMCopy );
          pDOMCopy = pDOM.cloneNode( true );
          pDOMCopy.style = '';
          copyContainer.appendChild( pDOMCopy );

          removeTabIndex();

        } );    
      } );
       
      // configuration of the dom observer:
      var config = { attributes: true, childList: true, characterData: true, subtree: true };
       
      // pass in the target node, as well as the observer options
      domObserver.observe( pDOM, config);

      // add mutation observers to each of the aria-live elements
      var addLiveObserver = function( container, originalElement, copiedElement ) {
        var liveObserver = new MutationObserver( function( mutations ) {
          mutations.forEach( function( mutation ) {
            container.removeChild( copiedElement );
            copiedElement = originalElement.cloneNode( true );
            copiedElement.style = '';
            container.appendChild( copiedElement );
          } );
        } );

        liveObserver.observe( originalElement, config )
      };

      addLiveObserver( assertiveElementContainer, assertiveElement, assertiveElementCopy );
      addLiveObserver( politeElementContainer, politeElement, politeElementCopy );
      addLiveObserver( assertiveAlertElementCopy, assertiveAlertElement, assertiveAlertElementCopy );
      addLiveObserver( politeStatusElementContainer, politeStatusElement, politeStatusElementCopy );

      // set focus to the loaded ifram
      document.getElementById( 'iframe' ).focus();
      
    }
  } );
</script>
</body>
</html>
