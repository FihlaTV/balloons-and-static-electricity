<!DOCTYPE HTML>
<!-- Copyright 2016, University of Colorado Boulder -->

<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="phet-sim-level" content="production">
  <title>&#8234;Balloons and Static Electricity&#8236; 1.2.0-reader.7 iframe test</title>
</head>
<body bgcolor="#F0F8FF">
<style>
  body {
    font-family: Arial, Helvetica, sans-serif
  }
  div.simulation_frame {
    float: left;
    margin: 50px;
  }
  div.pdom_copy {
    float: left;
    margin: 50px;
  }
  div.pdom_copy_container {
    overflow: auto;
    width: 500px;
    height: 500px;
  }
  div.clearfix {
    clear: both;
  }
</style>

<h1>Accessibility visualization for &#8234;Balloons and Static Electricity&#8236;</h1>

<div class="simulation_frame">
  <h2>Simulation embedded below</h2>
  <iframe id="iframe" width="600" height="400" allowfullscreen scrolling="no" style="float: left display: inline"></iframe>
</div>

<script type="application/javascript">

  // Grab all query parameters to pass to the simulation, and add additional ones for receiving messages.
  var simulationQueryString = window.location.search;
  if ( simulationQueryString.indexOf( '?' ) >= 0 ) {
    simulationQueryString += '&';
  }
  else {
    simulationQueryString += '?';
  }
  simulationQueryString += 'postMessageOnLoad&postMessageOnError';
  document.getElementById( 'iframe' ).setAttribute( 'src', 'balloons-and-static-electricity_en.html' + simulationQueryString );
</script>

<!--The PDOM copy will be placed in this container -->
<div class="pdom_copy">
  <h2>Parallel DOM is copied below</h2>
  <div id=dom-copy-container class="pdom_copy_container"></div>
</div>

<!--clear the blocks after the float effect-->
<div class="clearfix"></div>

<script type="application/javascript">

  // handling messages from sims
  window.addEventListener( 'message', function( evt ) {
    var data = JSON.parse( evt.data );

    // if load is successful, create a visualization of the parallel DOM
    if ( data.type === 'load' ) {

      var iframe = document.getElementById( 'iframe' );
      var innerDoc = iframe.contentDocument || iframe.contentWindow.document;

      var pDOM = innerDoc.getElementsByClassName( 'accessibility' )[ 0 ];
      var pDOMCopy = pDOM.cloneNode( true );

      // strip the styling from the copied parallel DOM
      pDOMCopy.style = '';

      // get the parent container for the parallel DOM copy
      var copyContainer = document.getElementById( 'dom-copy-container' );

      // add the dom copy to the documnet
      copyContainer.appendChild( pDOMCopy );

      // remove all elements in the PDOM copy from the navigation order
      var removeTabIndex = function() {
        var allElements = pDOMCopy.getElementsByTagName( "*" );
        for ( var i = 0; i < allElements.length; i++ ) {
          // Do something with the element here
          allElements[ i ].tabIndex = '-1';
        }
      };
      removeTabIndex();

      // whenever an element in the parallel DOM changes, we need to update its 
      // copied element as well
      var observer = new MutationObserver( function( mutations ) {
        mutations.forEach( function( mutation ) {

          // This is extremely ineficient - every time the document changes, make a new copy, remove
          // the visual dom, and add a new one
          // TODO: Work on refining this, and only modifying the elements that change in the PDOM.
          copyContainer.removeChild( pDOMCopy );
          pDOMCopy = pDOM.cloneNode( true );
          pDOMCopy.style = '';
          copyContainer.appendChild( pDOMCopy );

          removeTabIndex();

        } );    
      } );
       
      // configuration of the observer:
      var config = { attributes: true, childList: true, characterData: true, subtree: true };
       
      // pass in the target node, as well as the observer options
      observer.observe( pDOM, config);

      // set focus to the loaded ifram
      document.getElementById( 'iframe' ).focus();
      
    }
  } );
</script>
</body>
</html>
